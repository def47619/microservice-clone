# 인수 테스트 : `RestAssured`

### gradle 
```
dependencies {
    ,,,
    testImplementation 'io.rest-assured:rest-assured:5.1.1'
    ,,,
}
```

### 테스트 코드: ProductServiceApplicationTests
- 전체 Java 코드: 
```java
package com.leew.microservice.product_service;

import io.restassured.RestAssured;
import org.hamcrest.Matchers;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.boot.testcontainers.service.connection.ServiceConnection;
import org.springframework.context.annotation.Import;
import org.testcontainers.containers.MongoDBContainer;

@Import(TestcontainersConfiguration.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class ProductServiceApplicationTests {
	/**
	 * 테스트를 지금 실행 중인 프로세스들과 겹치지 않기 위해 Random Port 정해서
	 * 다른 포트에서 테스트 수행
	 *
	 * 내장 Tomcat/Netty 서버가 뜨고, Bean / Controller / Service / Repository 모두 활성화됨
	 * => 통합 테스트 위한 라이브러리
	 */

	@Test
	void contextLoads() {
	}

	/** 우리가 쓰는 컨테이너의 버전과 같은 설정값으로 맞춰야 함
	 *	TestContainer: Docker 통해 MongoDB 띄움 -> 실제 Production 환경에 맞게 버전 설정
	 *  static 블록에서 테스트 시작 전에 컨테이너 자동 시작
	 */
	@ServiceConnection
	static MongoDBContainer mongoDBContainer = new MongoDBContainer("mongo:7.0.5");

	static {
		mongoDBContainer.start();
	}

	/**
	 * 테스트를 Random Port로 띄웠기 떄문에
	 * 어떤 포트인지 테스트 코드가 몰라서 이렇게 DI로 받음
	 */
	@LocalServerPort
	private Integer port;

	/**
	 * RestAssured 객체에 요청 보낼 endpoint(URI + Port) 설정
	 */
	@BeforeEach
	void setup() {
		RestAssured.baseURI = "http://localhost";
		RestAssured.port = port;
	}

	/**
	 * RestAssured API로 통합 테스트
	 */
	@Test
	void shouldCreateProduct() {
		/**
		 * [POST] localhost:8001/api/product
		 * ->
		 * {
		 *     "id": "6920e02876bce73deaafab0a",
		 *     "name": "iPhone 17",
		 *     "description": "iPhone 17 is a smartphone from Apple",
		 *     "price": 1000
		 * }
		 */
		String requestBody = """
					{
				     "name": "iPhone 17",
				     "description": "iPhone 17 is a smartphone from Apple",
				     "price": 1000
					}
				""";

		RestAssured.given()
				.contentType("application/json")
				.body(requestBody)
				.when()
				.post("/api/product") // POST 요청 전송
				.then() // 응답 검증 시작
				.statusCode(201)
				.body("id", Matchers.notNullValue())
				.body("name", Matchers.equalTo("iPhone 17"))
				.body("description", Matchers.equalTo("iPhone 17 is a smartphone from Apple"))
				.body("price", Matchers.equalTo(1000));
	}

	/**
	 * 결과적으로, 실제 DB 없이 완전히 독립된 컨테이너 기반 테스트
	 * 로컬 MongoDB를 건드리지 않음 (테스트 오염 없음)
	 * API를 실제 요청처럼 테스트 -> 단위 테스트보다 신뢰도가 높음
	 * Docker를 사용하기 때문에 CI에서도 동일하게 동작
	 */
}
```